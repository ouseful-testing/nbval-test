name: nbval-partial-test
on:
  push:
    paths:
      - "**.ipynb"
jobs:
  nbval-partial-demo:
    runs-on: ubuntu-latest
    container:
      image: ouvocl/vce-tm351-monolith
    steps:
    - uses: actions/checkout@master
#      with:
#        ref: nbval-test-tags
    - id: files
      uses: jitterbit/get-changed-files@v1
      # Filepaths may contain spaces
      with:
        format: 'csv'
    - name: Install nbval (TH edition)
      run: |
        python3 -m pip install --upgrade git+https://github.com/ouseful-PR/nbval.git@table-test
        #python3 -m pip install --upgrade git+https://github.com/innovationOUtside/nb_workflow_tools.git
    - name: Restart postgres
      run: |
        sudo service postgresql restart
    - name: Start mongo
      run: |
        sudo mongod --fork --logpath /dev/stdout --dbpath ${MONGO_DB_PATH}
    - name: test changed files
      run: |
        mapfile -d ',' -t added_modified_files < <(printf '%s,' '${{ steps.files.outputs.added_modified }}')
        for added_modified_file in "${added_modified_files[@]}"; do
          if [[ "${added_modified_file}" == *.ipynb ]]; then
           py.test  --nbval "${added_modified_file}" || continue
          fi
        done
